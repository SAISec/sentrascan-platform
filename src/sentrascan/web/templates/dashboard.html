{% extends "base.html" %}

{% block title %}Dashboard - SentraScan Platform{% endblock %}

{% block nav_dashboard_active %}nav-link-active{% endblock %}

{% block content %}
{% include 'components/_breadcrumb.html' with context %}

<!-- Dashboard Header -->
<header class="dashboard-header" aria-labelledby="dashboard-title" style="margin-bottom: var(--spacing-xl);">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
    <div>
      <h1 id="dashboard-title" style="margin: 0 0 var(--spacing-xs) 0;">Dashboard</h1>
      <p style="margin: 0; color: var(--color-text-secondary); font-size: var(--font-size-base);">
        Overview of your security scans and findings
      </p>
    </div>
    <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
      <a href="/ui/scan" class="btn btn-primary">
        Run Scan
      </a>
      <div class="export-dropdown" style="position: relative;">
        <button class="btn btn-secondary export-button" aria-label="Export dashboard data" aria-expanded="false" style="display: flex; align-items: center; gap: var(--spacing-xs);">
          Export
          <span class="icon icon-chevron-down icon-sm" aria-hidden="true">âŒ„</span>
        </button>
        <div class="export-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: var(--spacing-xs); background: var(--color-bg-primary); border: 1px solid var(--color-border-light); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 150px; z-index: var(--z-index-dropdown);">
          <ul style="list-style: none; margin: 0; padding: var(--spacing-xs);">
            <li>
              <a href="/api/v1/dashboard/export?format=csv" class="export-link" style="display: block; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-sm); transition: background-color var(--transition-fast); text-decoration: none; color: var(--color-text-primary);">
                Export as CSV
              </a>
            </li>
            <li>
              <a href="/api/v1/dashboard/export?format=json" class="export-link" style="display: block; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-sm); transition: background-color var(--transition-fast); text-decoration: none; color: var(--color-text-primary);">
                Export as JSON
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Dashboard Filters -->
<section class="dashboard-filters card" aria-label="Dashboard filters" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md);">
  <form method="get" action="/" class="dashboard-filter-form" style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; align-items: end;">
    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
      <label for="filter_type" class="form-label">Scan Type</label>
      <select id="filter_type" name="type" class="form-select">
        <option value="">All Types</option>
        <option value="model" {% if filters.type == 'model' %}selected{% endif %}>Model</option>
        <option value="mcp" {% if filters.type == 'mcp' %}selected{% endif %}>MCP</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
      <label for="filter_status" class="form-label">Status</label>
      <select id="filter_status" name="passed" class="form-select">
        <option value="">All Status</option>
        <option value="true" {% if filters.passed == 'true' %}selected{% endif %}>Passed</option>
        <option value="false" {% if filters.passed == 'false' %}selected{% endif %}>Failed</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
      <label for="filter_time_range" class="form-label">Time Range</label>
      <select id="filter_time_range" name="time_range" class="form-select">
        <option value="">All Time</option>
        <option value="7d" {% if filters.time_range == '7d' %}selected{% endif %}>Last 7 days</option>
        <option value="30d" {% if filters.time_range == '30d' %}selected{% endif %}>Last 30 days</option>
        <option value="90d" {% if filters.time_range == '90d' %}selected{% endif %}>Last 90 days</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
      <label for="filter_date_from" class="form-label">Date From</label>
      <input type="date" id="filter_date_from" name="date_from" class="form-input" value="{{ filters.date_from if filters.date_from else '' }}">
    </div>
    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
      <label for="filter_date_to" class="form-label">Date To</label>
      <input type="date" id="filter_date_to" name="date_to" class="form-input" value="{{ filters.date_to if filters.date_to else '' }}">
    </div>
    <div class="form-group" style="margin-bottom: 0; display: flex; gap: var(--spacing-sm);">
      <button type="submit" class="btn btn-secondary">Apply Filters</button>
      <button type="button" id="clear-all-filters-btn" class="btn btn-secondary" onclick="clearAllFilters()" style="display: {% if filters.type or filters.passed or filters.time_range or filters.date_from or filters.date_to %}inline-block{% else %}none{% endif %};">Clear All</button>
    </div>
  </form>
  
  <!-- Active Filters Display (Filter Chips) -->
  <div id="filter-chips-container" class="active-filters" style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border-light); display: flex; flex-wrap: wrap; gap: var(--spacing-xs); align-items: center; min-height: 32px;">
    {% if filters.type %}
    <span class="filter-chip badge badge-neutral" data-filter-key="type" data-filter-value="{{ filters.type }}" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      Type: {{ filters.type|upper }}
      <button class="filter-chip-remove" onclick="removeFilterChip('type')" aria-label="Remove type filter" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: var(--spacing-xs);">Ã—</button>
    </span>
    {% endif %}
    {% if filters.passed %}
    <span class="filter-chip badge badge-neutral" data-filter-key="passed" data-filter-value="{{ filters.passed }}" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      Status: {{ 'Passed' if filters.passed == 'true' else 'Failed' }}
      <button class="filter-chip-remove" onclick="removeFilterChip('passed')" aria-label="Remove status filter" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: var(--spacing-xs);">Ã—</button>
    </span>
    {% endif %}
    {% if filters.time_range %}
    <span class="filter-chip badge badge-neutral" data-filter-key="time_range" data-filter-value="{{ filters.time_range }}" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      Time: {{ 'Last 7 days' if filters.time_range == '7d' else ('Last 30 days' if filters.time_range == '30d' else 'Last 90 days') }}
      <button class="filter-chip-remove" onclick="removeFilterChip('time_range')" aria-label="Remove time range filter" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: var(--spacing-xs);">Ã—</button>
    </span>
    {% endif %}
    {% if filters.date_from %}
    <span class="filter-chip badge badge-neutral" data-filter-key="date_from" data-filter-value="{{ filters.date_from }}" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      From: {{ filters.date_from }}
      <button class="filter-chip-remove" onclick="removeFilterChip('date_from')" aria-label="Remove date from filter" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: var(--spacing-xs);">Ã—</button>
    </span>
    {% endif %}
    {% if filters.date_to %}
    <span class="filter-chip badge badge-neutral" data-filter-key="date_to" data-filter-value="{{ filters.date_to }}" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      To: {{ filters.date_to }}
      <button class="filter-chip-remove" onclick="removeFilterChip('date_to')" aria-label="Remove date to filter" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: var(--spacing-xs);">Ã—</button>
    </span>
    {% endif %}
    {% if filters.search %}
    <span class="filter-chip badge badge-neutral" data-filter-key="search" data-filter-value="{{ filters.search }}" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      Search: {{ filters.search }}
      <button class="filter-chip-remove" onclick="removeFilterChip('search')" aria-label="Remove search filter" style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; margin-left: var(--spacing-xs);">Ã—</button>
    </span>
    {% endif %}
  </div>
</section>

<!-- Statistics Cards -->
<section class="stats-grid grid grid-4" aria-label="Dashboard statistics" style="margin-bottom: var(--spacing-xl);">
  <!-- Total Scans Card -->
  <div class="stat-card card">
    <div class="stat-card-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
      <div>
        <h3 class="stat-card-title" style="margin: 0 0 var(--spacing-xs) 0; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">
          Total Scans
        </h3>
        <p class="stat-card-value" style="margin: 0; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">
          {{ stats.total_scans if stats else (scans|length if scans else 0) }}
        </p>
      </div>
      <div class="stat-card-icon" style="width: 48px; height: 48px; background-color: var(--color-primary); opacity: 0.1; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;" aria-hidden="true">
        <span style="font-size: 24px;" aria-hidden="true">ðŸ“Š</span>
      </div>
    </div>
    <p class="stat-card-description" style="margin: 0; font-size: var(--font-size-xs); color: var(--color-text-tertiary);">
      All time scan count
    </p>
  </div>

  <!-- Pass Rate Card -->
  <div class="stat-card card">
    <div class="stat-card-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
      <div>
        <h3 class="stat-card-title" style="margin: 0 0 var(--spacing-xs) 0; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">
          Pass Rate
        </h3>
        <p class="stat-card-value" style="margin: 0; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">
          {% if stats and stats.total_scans > 0 %}
            {{ "%.1f"|format((stats.passed_scans / stats.total_scans * 100) if stats.passed_scans else 0) }}%
          {% else %}
            {% set passed_count = scans|selectattr('passed', 'equalto', True)|list|length if scans else 0 %}
            {% set total_count = scans|length if scans else 1 %}
            {{ "%.1f"|format((passed_count / total_count * 100) if total_count > 0 else 0) }}%
          {% endif %}
        </p>
      </div>
      <div class="stat-card-icon" style="width: 48px; height: 48px; background-color: var(--color-success); opacity: 0.1; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;" aria-hidden="true">
        <span style="font-size: 24px;" aria-hidden="true">âœ“</span>
      </div>
    </div>
    <p class="stat-card-description" style="margin: 0; font-size: var(--font-size-xs); color: var(--color-text-tertiary);">
      Scans that passed security checks
    </p>
  </div>

  <!-- Total Findings Card -->
  <div class="stat-card card">
    <div class="stat-card-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
      <div>
        <h3 class="stat-card-title" style="margin: 0 0 var(--spacing-xs) 0; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">
          Total Findings
        </h3>
        <p class="stat-card-value" style="margin: 0; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">
          {% if stats %}
            {{ stats.total_findings }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.critical_count or 0) + (scan.high_count or 0) + (scan.medium_count or 0) + (scan.low_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </p>
      </div>
      <div class="stat-card-icon" style="width: 48px; height: 48px; background-color: var(--color-warning); opacity: 0.1; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;" aria-hidden="true">
        <span style="font-size: 24px;" aria-hidden="true">âš </span>
      </div>
    </div>
    <p class="stat-card-description" style="margin: 0; font-size: var(--font-size-xs); color: var(--color-text-tertiary);">
      Security issues detected
    </p>
  </div>

  <!-- Severity Breakdown Card -->
  <div class="stat-card card">
    <div class="stat-card-header" style="margin-bottom: var(--spacing-md);">
      <h3 class="stat-card-title" style="margin: 0 0 var(--spacing-md) 0; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">
        Severity Breakdown
      </h3>
    </div>
    <div class="severity-breakdown" style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="badge badge-critical">Critical</span>
        <span style="font-weight: var(--font-weight-semibold);">
          {% if stats %}
            {{ stats.critical_count }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.critical_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="badge badge-high">High</span>
        <span style="font-weight: var(--font-weight-semibold);">
          {% if stats %}
            {{ stats.high_count }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.high_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="badge badge-medium">Medium</span>
        <span style="font-weight: var(--font-weight-semibold);">
          {% if stats %}
            {{ stats.medium_count }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.medium_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="badge badge-low">Low</span>
        <span style="font-weight: var(--font-weight-semibold);">
          {% if stats %}
            {{ stats.low_count }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.low_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </span>
      </div>
    </div>
  </div>
</section>

<!-- Charts Section -->
{% if stats and stats.total_scans > 0 %}
<section class="charts-section" aria-labelledby="charts-title" style="margin-bottom: var(--spacing-xl);">
  <h2 id="charts-title" style="margin-bottom: var(--spacing-lg);">Analytics</h2>
  
  <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
    <!-- Scan Trends Chart -->
    <div class="chart-card card" style="padding: var(--spacing-lg);">
      <h3 style="margin: 0 0 var(--spacing-md) 0; font-size: var(--font-size-base);">Scan Trends</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="scan-trends-chart" role="img" aria-label="Line chart showing scan trends over time"></canvas>
      </div>
    </div>
    
    <!-- Severity Distribution Chart -->
    <div class="chart-card card" style="padding: var(--spacing-lg);">
      <h3 style="margin: 0 0 var(--spacing-md) 0; font-size: var(--font-size-base);">Severity Distribution</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="severity-chart" role="img" aria-label="Donut chart showing severity distribution"></canvas>
      </div>
    </div>
    
    <!-- Pass/Fail Ratio Chart -->
    <div class="chart-card card" style="padding: var(--spacing-lg);">
      <h3 style="margin: 0 0 var(--spacing-md) 0; font-size: var(--font-size-base);">Pass/Fail Ratio</h3>
      <div style="position: relative; height: 300px;">
        <canvas id="pass-fail-chart" role="img" aria-label="Bar chart showing pass/fail ratios"></canvas>
      </div>
    </div>
  </div>
</section>
{% else %}
<div class="empty-state card" style="text-align: center; padding: var(--spacing-2xl); margin-bottom: var(--spacing-xl);">
  <p style="font-size: var(--font-size-lg); color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
    No data available for charts
  </p>
  <p style="color: var(--color-text-tertiary); margin-bottom: var(--spacing-lg);">
    Run some scans to see analytics
  </p>
  <a href="/ui/scan" class="btn btn-primary">Run Your First Scan</a>
</div>
{% endif %}

<!-- Recent Activity Section -->
<section class="recent-activity-section" aria-labelledby="recent-scans-title" style="margin-bottom: var(--spacing-xl);">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
    <h2 id="recent-scans-title" style="margin: 0;">Recent Scans</h2>
    <a href="/" class="btn btn-secondary btn-sm">View All</a>
  </div>

  {% if scans and scans|length > 0 %}
  <div class="table-container">
    <table class="table" role="table" aria-label="Recent scans">
      <caption class="sr-only">Table showing recent security scans</caption>
      <thead>
        <tr>
          <th scope="col">Time</th>
          <th scope="col">Type</th>
          <th scope="col">Target</th>
          <th scope="col">Status</th>
          <th scope="col">Findings</th>
        </tr>
      </thead>
      <tbody>
        {% for scan in scans[:10] %}
        <tr style="cursor: pointer;" onclick="window.location.href='/scan/{{ scan.id }}'">
          <td>
            <a href="/scan/{{ scan.id }}" style="text-decoration: none; color: inherit;">
              {{ scan.created_at.strftime('%Y-%m-%d %H:%M') if scan.created_at.strftime else scan.created_at }}
            </a>
          </td>
          <td>
            <span class="badge badge-neutral">{{ scan.scan_type|upper }}</span>
          </td>
          <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            <a href="/scan/{{ scan.id }}" style="text-decoration: none; color: inherit;" title="{{ scan.target_path }}">
              {{ scan.target_path }}
            </a>
          </td>
          <td>
            {% if scan.passed %}
              <span class="badge badge-success">PASS</span>
            {% else %}
              <span class="badge badge-error">FAIL</span>
            {% endif %}
          </td>
          <td>
            <div style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;">
              {% if scan.critical_count > 0 %}
                <span class="badge badge-critical">{{ scan.critical_count }}</span>
              {% endif %}
              {% if scan.high_count > 0 %}
                <span class="badge badge-high">{{ scan.high_count }}</span>
              {% endif %}
              {% if scan.medium_count > 0 %}
                <span class="badge badge-medium">{{ scan.medium_count }}</span>
              {% endif %}
              {% if scan.low_count > 0 %}
                <span class="badge badge-low">{{ scan.low_count }}</span>
              {% endif %}
              {% if (scan.critical_count or 0) + (scan.high_count or 0) + (scan.medium_count or 0) + (scan.low_count or 0) == 0 %}
                <span style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">None</span>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state card" style="text-align: center; padding: var(--spacing-2xl);">
    <p style="font-size: var(--font-size-lg); color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
      No scans yet
    </p>
    <p style="color: var(--color-text-tertiary); margin-bottom: var(--spacing-lg);">
      Get started by running your first scan
    </p>
    <a href="/ui/scan" class="btn btn-primary">Run Your First Scan</a>
  </div>
  {% endif %}
</section>

<!-- Dashboard Scripts -->
<script src="/static/js/charts.js"></script>
<script>
(function() {
  'use strict';
  
  // ============================================
  // Initialize Charts
  // ============================================
  
  let charts = {};
  
  async function loadCharts() {
    try {
      const params = new URLSearchParams(window.location.search);
      // Remove page params for chart data
      params.delete('page');
      params.delete('page_size');
      params.delete('search');
      params.delete('sort');
      params.delete('order');
      const response = await fetch(`/api/v1/dashboard/charts?${params.toString()}`, { credentials: 'include' });
      if (!response.ok) {
        throw new Error('Failed to load chart data');
      }
      
      const data = await response.json();
      
      // Create scan trends chart
      if (data.trends && data.trends.labels.length > 0) {
        charts.trends = createScanTrendsChart('scan-trends-chart', data.trends, {
          onClick: (element) => {
            const date = data.trends.labels[element.index];
            // Filter by date (could be enhanced)
            if (typeof showToast !== 'undefined') {
              showToast(`Clicked on ${date}`, 'info');
            }
          }
        });
      } else {
        // Show empty state
        const canvas = document.getElementById('scan-trends-chart');
        if (canvas) {
          canvas.parentElement.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">No trend data available</p>';
        }
      }
      
      // Create severity chart
      if (data.severity) {
        const total = (data.severity.critical || 0) + (data.severity.high || 0) + (data.severity.medium || 0) + (data.severity.low || 0);
        if (total > 0) {
          charts.severity = createSeverityChart('severity-chart', data.severity, {
            type: 'doughnut',
            onClick: (data) => {
              // Filter by severity
              const severity = data.label.toLowerCase();
              window.location.href = `/?severity=${severity}`;
            }
          });
        } else {
          const canvas = document.getElementById('severity-chart');
          if (canvas) {
            canvas.parentElement.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">No severity data available</p>';
          }
        }
      }
      
      // Create pass/fail chart
      if (data.passFail) {
        const total = (data.passFail.passed || 0) + (data.passFail.failed || 0);
        if (total > 0) {
          charts.passFail = createPassFailChart('pass-fail-chart', data.passFail, {
            onClick: (data) => {
              // Filter by pass/fail
              const passed = data.label.toLowerCase() === 'passed';
              window.location.href = `/?passed=${passed}`;
            }
          });
        } else {
          const canvas = document.getElementById('pass-fail-chart');
          if (canvas) {
            canvas.parentElement.innerHTML = '<p style="text-align: center; color: var(--color-text-secondary); padding: var(--spacing-lg);">No pass/fail data available</p>';
          }
        }
      }
    } catch (error) {
      console.error('Error loading charts:', error);
    }
  }
  
  // Load charts when Chart.js is ready
  if (typeof Chart !== 'undefined') {
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadCharts);
    } else {
      loadCharts();
    }
  } else {
    // Wait for Chart.js to load
    window.addEventListener('load', () => {
      setTimeout(loadCharts, 100);
    });
  }
  
  // ============================================
  // Auto-refresh functionality
  // ============================================
  
  let refreshInterval = null;
  const REFRESH_INTERVAL = 30000; // 30 seconds
  
  function refreshDashboard() {
    // Only refresh if page is visible
    if (document.hidden) return;
    
    // Reload the page to get updated statistics
    // In the future, this could be an AJAX call to update only stats
    window.location.reload();
  }
  
  function startAutoRefresh() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }
    refreshInterval = setInterval(refreshDashboard, REFRESH_INTERVAL);
  }
  
  function stopAutoRefresh() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
      refreshInterval = null;
    }
  }
  
  // Start auto-refresh when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startAutoRefresh);
  } else {
    startAutoRefresh();
  }
  
  // Pause auto-refresh when page is hidden
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      stopAutoRefresh();
    } else {
      startAutoRefresh();
    }
  });
  
  // Clean up on page unload
  window.addEventListener('beforeunload', stopAutoRefresh);
  
  // ============================================
  // Export dropdown functionality
  // ============================================
  
  const exportButton = document.querySelector('.export-button');
  const exportMenu = document.querySelector('.export-menu');
  
  if (exportButton && exportMenu) {
    exportButton.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const isOpen = exportMenu.style.display === 'block';
      exportMenu.style.display = isOpen ? 'none' : 'block';
      exportButton.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
    });
    
    // Close on outside click
    document.addEventListener('click', function(e) {
      if (!exportButton.contains(e.target) && !exportMenu.contains(e.target)) {
        exportMenu.style.display = 'none';
        exportButton.setAttribute('aria-expanded', 'false');
      }
    });
    
    // Keyboard support
    exportButton.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        exportButton.click();
      } else if (e.key === 'Escape') {
        exportMenu.style.display = 'none';
        exportButton.setAttribute('aria-expanded', 'false');
      }
    });
  }
})();
</script>

{% endblock %}

