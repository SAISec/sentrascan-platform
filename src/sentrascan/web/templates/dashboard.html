{% extends "base.html" %}

{% block title %}Dashboard - SentraScan Platform{% endblock %}

{% block nav_dashboard_active %}nav-link-active{% endblock %}

{% block content %}
{% include 'components/_breadcrumb.html' with context %}

<!-- Dashboard Header -->
<div class="dashboard-header" style="margin-bottom: var(--spacing-xl);">
  <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--spacing-md);">
    <div>
      <h1 style="margin: 0 0 var(--spacing-xs) 0;">Dashboard</h1>
      <p style="margin: 0; color: var(--color-text-secondary); font-size: var(--font-size-base);">
        Overview of your security scans and findings
      </p>
    </div>
    <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
      <a href="/ui/scan" class="btn btn-primary">
        Run Scan
      </a>
      <div class="export-dropdown" style="position: relative;">
        <button class="btn btn-secondary export-button" aria-label="Export dashboard data" aria-expanded="false" style="display: flex; align-items: center; gap: var(--spacing-xs);">
          Export
          <span class="icon icon-chevron-down icon-sm" aria-hidden="true">âŒ„</span>
        </button>
        <div class="export-menu" style="display: none; position: absolute; top: 100%; right: 0; margin-top: var(--spacing-xs); background: var(--color-bg-primary); border: 1px solid var(--color-border-light); border-radius: var(--radius-md); box-shadow: var(--shadow-lg); min-width: 150px; z-index: var(--z-index-dropdown);">
          <ul style="list-style: none; margin: 0; padding: var(--spacing-xs);">
            <li>
              <a href="/api/v1/dashboard/export?format=csv" class="export-link" style="display: block; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-sm); transition: background-color var(--transition-fast); text-decoration: none; color: var(--color-text-primary);">
                Export as CSV
              </a>
            </li>
            <li>
              <a href="/api/v1/dashboard/export?format=json" class="export-link" style="display: block; padding: var(--spacing-sm) var(--spacing-md); border-radius: var(--radius-sm); transition: background-color var(--transition-fast); text-decoration: none; color: var(--color-text-primary);">
                Export as JSON
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Dashboard Filters -->
<div class="dashboard-filters card" style="margin-bottom: var(--spacing-lg); padding: var(--spacing-md);">
  <form method="get" action="/" class="dashboard-filter-form" style="display: flex; gap: var(--spacing-md); flex-wrap: wrap; align-items: end;">
    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
      <label for="filter_type" class="form-label">Scan Type</label>
      <select id="filter_type" name="type" class="form-select">
        <option value="">All Types</option>
        <option value="model" {% if filters.type == 'model' %}selected{% endif %}>Model</option>
        <option value="mcp" {% if filters.type == 'mcp' %}selected{% endif %}>MCP</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
      <label for="filter_status" class="form-label">Status</label>
      <select id="filter_status" name="passed" class="form-select">
        <option value="">All Status</option>
        <option value="true" {% if filters.passed == 'true' %}selected{% endif %}>Passed</option>
        <option value="false" {% if filters.passed == 'false' %}selected{% endif %}>Failed</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 150px;">
      <label for="filter_time_range" class="form-label">Time Range</label>
      <select id="filter_time_range" name="time_range" class="form-select">
        <option value="">All Time</option>
        <option value="7d" {% if filters.time_range == '7d' %}selected{% endif %}>Last 7 days</option>
        <option value="30d" {% if filters.time_range == '30d' %}selected{% endif %}>Last 30 days</option>
        <option value="90d" {% if filters.time_range == '90d' %}selected{% endif %}>Last 90 days</option>
      </select>
    </div>
    <div class="form-group" style="margin-bottom: 0; display: flex; gap: var(--spacing-sm);">
      <button type="submit" class="btn btn-secondary">Apply Filters</button>
      {% if filters.type or filters.passed or filters.time_range %}
      <a href="/" class="btn btn-secondary">Clear</a>
      {% endif %}
    </div>
  </form>
  
  <!-- Active Filters Display -->
  {% if filters.type or filters.passed or filters.time_range %}
  <div class="active-filters" style="margin-top: var(--spacing-md); padding-top: var(--spacing-md); border-top: 1px solid var(--color-border-light); display: flex; flex-wrap: wrap; gap: var(--spacing-xs); align-items: center;">
    <span style="font-size: var(--font-size-sm); color: var(--color-text-secondary);">Active filters:</span>
    {% if filters.type %}
    <span class="badge badge-neutral" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      Type: {{ filters.type|upper }}
      <a href="?{% if filters.passed %}passed={{ filters.passed }}&{% endif %}{% if filters.time_range %}time_range={{ filters.time_range }}{% endif %}" style="color: inherit; text-decoration: none; margin-left: var(--spacing-xs);" aria-label="Remove type filter">Ã—</a>
    </span>
    {% endif %}
    {% if filters.passed %}
    <span class="badge badge-neutral" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      Status: {{ 'Passed' if filters.passed == 'true' else 'Failed' }}
      <a href="?{% if filters.type %}type={{ filters.type }}&{% endif %}{% if filters.time_range %}time_range={{ filters.time_range }}{% endif %}" style="color: inherit; text-decoration: none; margin-left: var(--spacing-xs);" aria-label="Remove status filter">Ã—</a>
    </span>
    {% endif %}
    {% if filters.time_range %}
    <span class="badge badge-neutral" style="display: inline-flex; align-items: center; gap: var(--spacing-xs);">
      Time: {{ 'Last 7 days' if filters.time_range == '7d' else ('Last 30 days' if filters.time_range == '30d' else 'Last 90 days') }}
      <a href="?{% if filters.type %}type={{ filters.type }}&{% endif %}{% if filters.passed %}passed={{ filters.passed }}{% endif %}" style="color: inherit; text-decoration: none; margin-left: var(--spacing-xs);" aria-label="Remove time range filter">Ã—</a>
    </span>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Statistics Cards -->
<div class="stats-grid grid grid-4" style="margin-bottom: var(--spacing-xl);">
  <!-- Total Scans Card -->
  <div class="stat-card card">
    <div class="stat-card-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
      <div>
        <h3 class="stat-card-title" style="margin: 0 0 var(--spacing-xs) 0; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">
          Total Scans
        </h3>
        <p class="stat-card-value" style="margin: 0; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">
          {{ stats.total_scans if stats else (scans|length if scans else 0) }}
        </p>
      </div>
      <div class="stat-card-icon" style="width: 48px; height: 48px; background-color: var(--color-primary); opacity: 0.1; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 24px;" aria-hidden="true">ðŸ“Š</span>
      </div>
    </div>
    <p class="stat-card-description" style="margin: 0; font-size: var(--font-size-xs); color: var(--color-text-tertiary);">
      All time scan count
    </p>
  </div>

  <!-- Pass Rate Card -->
  <div class="stat-card card">
    <div class="stat-card-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
      <div>
        <h3 class="stat-card-title" style="margin: 0 0 var(--spacing-xs) 0; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">
          Pass Rate
        </h3>
        <p class="stat-card-value" style="margin: 0; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">
          {% if stats and stats.total_scans > 0 %}
            {{ "%.1f"|format((stats.passed_scans / stats.total_scans * 100) if stats.passed_scans else 0) }}%
          {% else %}
            {% set passed_count = scans|selectattr('passed', 'equalto', True)|list|length if scans else 0 %}
            {% set total_count = scans|length if scans else 1 %}
            {{ "%.1f"|format((passed_count / total_count * 100) if total_count > 0 else 0) }}%
          {% endif %}
        </p>
      </div>
      <div class="stat-card-icon" style="width: 48px; height: 48px; background-color: var(--color-success); opacity: 0.1; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 24px;" aria-hidden="true">âœ“</span>
      </div>
    </div>
    <p class="stat-card-description" style="margin: 0; font-size: var(--font-size-xs); color: var(--color-text-tertiary);">
      Scans that passed security checks
    </p>
  </div>

  <!-- Total Findings Card -->
  <div class="stat-card card">
    <div class="stat-card-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--spacing-md);">
      <div>
        <h3 class="stat-card-title" style="margin: 0 0 var(--spacing-xs) 0; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">
          Total Findings
        </h3>
        <p class="stat-card-value" style="margin: 0; font-size: var(--font-size-3xl); font-weight: var(--font-weight-bold); color: var(--color-text-primary);">
          {% if stats %}
            {{ stats.total_findings }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.critical_count or 0) + (scan.high_count or 0) + (scan.medium_count or 0) + (scan.low_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </p>
      </div>
      <div class="stat-card-icon" style="width: 48px; height: 48px; background-color: var(--color-warning); opacity: 0.1; border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
        <span style="font-size: 24px;" aria-hidden="true">âš </span>
      </div>
    </div>
    <p class="stat-card-description" style="margin: 0; font-size: var(--font-size-xs); color: var(--color-text-tertiary);">
      Security issues detected
    </p>
  </div>

  <!-- Severity Breakdown Card -->
  <div class="stat-card card">
    <div class="stat-card-header" style="margin-bottom: var(--spacing-md);">
      <h3 class="stat-card-title" style="margin: 0 0 var(--spacing-md) 0; font-size: var(--font-size-sm); font-weight: var(--font-weight-medium); color: var(--color-text-secondary);">
        Severity Breakdown
      </h3>
    </div>
    <div class="severity-breakdown" style="display: flex; flex-direction: column; gap: var(--spacing-xs);">
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="badge badge-critical">Critical</span>
        <span style="font-weight: var(--font-weight-semibold);">
          {% if stats %}
            {{ stats.critical_count }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.critical_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="badge badge-high">High</span>
        <span style="font-weight: var(--font-weight-semibold);">
          {% if stats %}
            {{ stats.high_count }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.high_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="badge badge-medium">Medium</span>
        <span style="font-weight: var(--font-weight-semibold);">
          {% if stats %}
            {{ stats.medium_count }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.medium_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </span>
      </div>
      <div style="display: flex; justify-content: space-between; align-items: center;">
        <span class="badge badge-low">Low</span>
        <span style="font-weight: var(--font-weight-semibold);">
          {% if stats %}
            {{ stats.low_count }}
          {% else %}
            {% set total = 0 %}
            {% if scans %}
              {% for scan in scans %}
                {% set total = total + (scan.low_count or 0) %}
              {% endfor %}
            {% endif %}
            {{ total }}
          {% endif %}
        </span>
      </div>
    </div>
  </div>
</div>

<!-- Recent Activity Section -->
<div class="recent-activity-section" style="margin-bottom: var(--spacing-xl);">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-lg);">
    <h2 style="margin: 0;">Recent Scans</h2>
    <a href="/" class="btn btn-secondary btn-sm">View All</a>
  </div>

  {% if scans and scans|length > 0 %}
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Time</th>
          <th>Type</th>
          <th>Target</th>
          <th>Status</th>
          <th>Findings</th>
        </tr>
      </thead>
      <tbody>
        {% for scan in scans[:10] %}
        <tr style="cursor: pointer;" onclick="window.location.href='/scan/{{ scan.id }}'">
          <td>
            <a href="/scan/{{ scan.id }}" style="text-decoration: none; color: inherit;">
              {{ scan.created_at.strftime('%Y-%m-%d %H:%M') if scan.created_at.strftime else scan.created_at }}
            </a>
          </td>
          <td>
            <span class="badge badge-neutral">{{ scan.scan_type|upper }}</span>
          </td>
          <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
            <a href="/scan/{{ scan.id }}" style="text-decoration: none; color: inherit;" title="{{ scan.target_path }}">
              {{ scan.target_path }}
            </a>
          </td>
          <td>
            {% if scan.passed %}
              <span class="badge badge-success">PASS</span>
            {% else %}
              <span class="badge badge-error">FAIL</span>
            {% endif %}
          </td>
          <td>
            <div style="display: flex; gap: var(--spacing-xs); flex-wrap: wrap;">
              {% if scan.critical_count > 0 %}
                <span class="badge badge-critical">{{ scan.critical_count }}</span>
              {% endif %}
              {% if scan.high_count > 0 %}
                <span class="badge badge-high">{{ scan.high_count }}</span>
              {% endif %}
              {% if scan.medium_count > 0 %}
                <span class="badge badge-medium">{{ scan.medium_count }}</span>
              {% endif %}
              {% if scan.low_count > 0 %}
                <span class="badge badge-low">{{ scan.low_count }}</span>
              {% endif %}
              {% if (scan.critical_count or 0) + (scan.high_count or 0) + (scan.medium_count or 0) + (scan.low_count or 0) == 0 %}
                <span style="color: var(--color-text-tertiary); font-size: var(--font-size-sm);">None</span>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <div class="empty-state card" style="text-align: center; padding: var(--spacing-2xl);">
    <p style="font-size: var(--font-size-lg); color: var(--color-text-secondary); margin-bottom: var(--spacing-md);">
      No scans yet
    </p>
    <p style="color: var(--color-text-tertiary); margin-bottom: var(--spacing-lg);">
      Get started by running your first scan
    </p>
    <a href="/ui/scan" class="btn btn-primary">Run Your First Scan</a>
  </div>
  {% endif %}
</div>

<!-- Dashboard Scripts -->
<script>
(function() {
  'use strict';
  
  // ============================================
  // Auto-refresh functionality
  // ============================================
  
  let refreshInterval = null;
  const REFRESH_INTERVAL = 30000; // 30 seconds
  
  function refreshDashboard() {
    // Only refresh if page is visible
    if (document.hidden) return;
    
    // Reload the page to get updated statistics
    // In the future, this could be an AJAX call to update only stats
    window.location.reload();
  }
  
  function startAutoRefresh() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }
    refreshInterval = setInterval(refreshDashboard, REFRESH_INTERVAL);
  }
  
  function stopAutoRefresh() {
    if (refreshInterval) {
      clearInterval(refreshInterval);
      refreshInterval = null;
    }
  }
  
  // Start auto-refresh when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', startAutoRefresh);
  } else {
    startAutoRefresh();
  }
  
  // Pause auto-refresh when page is hidden
  document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
      stopAutoRefresh();
    } else {
      startAutoRefresh();
    }
  });
  
  // Clean up on page unload
  window.addEventListener('beforeunload', stopAutoRefresh);
  
  // ============================================
  // Export dropdown functionality
  // ============================================
  
  const exportButton = document.querySelector('.export-button');
  const exportMenu = document.querySelector('.export-menu');
  
  if (exportButton && exportMenu) {
    exportButton.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const isOpen = exportMenu.style.display === 'block';
      exportMenu.style.display = isOpen ? 'none' : 'block';
      exportButton.setAttribute('aria-expanded', isOpen ? 'false' : 'true');
    });
    
    // Close on outside click
    document.addEventListener('click', function(e) {
      if (!exportButton.contains(e.target) && !exportMenu.contains(e.target)) {
        exportMenu.style.display = 'none';
        exportButton.setAttribute('aria-expanded', 'false');
      }
    });
    
    // Keyboard support
    exportButton.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        exportButton.click();
      } else if (e.key === 'Escape') {
        exportMenu.style.display = 'none';
        exportButton.setAttribute('aria-expanded', 'false');
      }
    });
  }
})();
</script>

{% endblock %}

