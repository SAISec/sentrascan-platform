{% extends "base.html" %}

{% block title %}Login - SentraScan Platform{% endblock %}

{% block content %}
<div class="login-container" style="display: flex; align-items: center; justify-content: center; min-height: 60vh; padding: var(--spacing-xl) 0;">
  <div class="login-card card" style="width: 100%; max-width: 400px;">
    <div class="login-header" style="text-align: center; margin-bottom: var(--spacing-xl);">
      <h1 style="margin: 0 0 var(--spacing-sm) 0; font-size: var(--font-size-2xl); color: var(--color-text-primary);">
        Welcome Back
      </h1>
      <p style="margin: 0; font-size: var(--font-size-base); color: var(--color-text-secondary);">
        Sign in to SentraScan Platform
      </p>
    </div>

    {% if error %}
    <div class="alert alert-error" role="alert" aria-live="polite" 
         style="padding: var(--spacing-md); margin-bottom: var(--spacing-lg); background-color: #FEE; border: 1px solid var(--color-error); border-radius: var(--radius-md); color: var(--color-error);">
      <strong>Error:</strong> {{ error }}
    </div>
    {% endif %}

    <form method="post" action="/login" class="login-form" novalidate aria-label="Login form" id="loginForm">
      <fieldset style="border: none; margin: 0; padding: 0;">
        <legend class="sr-only">Login credentials</legend>
        
        <!-- Authentication Method Toggle -->
        <div class="form-group" style="margin-bottom: var(--spacing-md);">
          <div class="auth-method-toggle" style="display: flex; gap: var(--spacing-sm); border: 1px solid var(--color-border-light, #e0e0e0); border-radius: var(--radius-md, 4px); padding: var(--spacing-xs); background-color: var(--color-bg-secondary, #f5f5f5);">
            <button 
              type="button" 
              class="auth-toggle-btn active" 
              data-method="user"
              style="flex: 1; padding: var(--spacing-sm); border: none; background: var(--color-primary, #0066cc); color: white; border-radius: var(--radius-sm, 2px); cursor: pointer; font-weight: 500;"
              aria-pressed="true"
            >
              Email & Password
            </button>
            <button 
              type="button" 
              class="auth-toggle-btn" 
              data-method="api_key"
              style="flex: 1; padding: var(--spacing-sm); border: none; background: transparent; color: var(--color-text-secondary, #666); border-radius: var(--radius-sm, 2px); cursor: pointer; font-weight: 500;"
              aria-pressed="false"
            >
              API Key
            </button>
          </div>
        </div>

        <!-- Email/Password Fields (Default) -->
        <div id="userAuthFields" class="auth-fields">
          <div class="form-group">
            <label for="email" class="form-label required">
              Email Address
              <span class="sr-only">(required)</span>
            </label>
            <input 
              type="email" 
              id="email" 
              name="email" 
              class="form-input {% if error %}error{% endif %}" 
              required 
              autocomplete="email"
              aria-describedby="email_help {% if error %}email_error{% endif %}"
              aria-invalid="{% if error %}true{% else %}false{% endif %}"
              aria-required="true"
              placeholder="Enter your email address"
              autofocus
            />
            <p id="email_help" class="form-help-text">
              Enter your registered email address
            </p>
            <div id="email_error" class="form-error-message" role="alert" aria-live="assertive" style="{% if not error %}display: none;{% else %}display: block; color: var(--color-error, #F44336); font-size: var(--font-size-sm, 14px); margin-top: var(--spacing-xs, 4px);{% endif %}">
              {% if error %}{{ error }}{% endif %}
            </div>
          </div>

          <div class="form-group">
            <label for="password" class="form-label required">
              Password
              <span class="sr-only">(required)</span>
            </label>
            <div class="password-input-wrapper" style="position: relative;">
              <input 
                type="password" 
                id="password" 
                name="password" 
                class="form-input {% if error %}error{% endif %}" 
                required 
                autocomplete="current-password"
                aria-describedby="password_help {% if error %}password_error{% endif %}"
                aria-invalid="{% if error %}true{% else %}false{% endif %}"
                aria-required="true"
                placeholder="Enter your password"
                minlength="12"
              />
              <button 
                type="button" 
                class="password-toggle" 
                aria-label="Show password"
                aria-pressed="false"
                tabindex="0"
                style="position: absolute; right: var(--spacing-sm); top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: var(--spacing-xs); color: var(--color-text-secondary); min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"
              >
                <span class="password-toggle-icon" aria-hidden="true">üëÅ</span>
              </button>
            </div>
            <p id="password_help" class="form-help-text">
              Enter your password (minimum 12 characters)
            </p>
            <div id="password_error" class="form-error-message" role="alert" aria-live="assertive" style="{% if not error %}display: none;{% else %}display: block; color: var(--color-error, #F44336); font-size: var(--font-size-sm, 14px); margin-top: var(--spacing-xs, 4px);{% endif %}">
              {% if error %}{{ error }}{% endif %}
            </div>
          </div>
        </div>

        <!-- API Key Fields (Hidden by default) -->
        <div id="apiKeyAuthFields" class="auth-fields" style="display: none;">
          <div class="form-group">
            <label for="api_key" class="form-label required">
              API Key
              <span class="sr-only">(required)</span>
            </label>
            <div class="password-input-wrapper" style="position: relative;">
              <input 
                type="password" 
                id="api_key" 
                name="api_key" 
                class="form-input {% if error %}error{% endif %}" 
                autocomplete="current-password"
                aria-describedby="api_key_help {% if error %}api_key_error{% endif %}"
                aria-invalid="{% if error %}true{% else %}false{% endif %}"
                placeholder="Enter your API key"
                minlength="1"
              />
              <button 
                type="button" 
                class="password-toggle" 
                aria-label="Show password"
                aria-pressed="false"
                tabindex="0"
                style="position: absolute; right: var(--spacing-sm); top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; padding: var(--spacing-xs); color: var(--color-text-secondary); min-width: 44px; min-height: 44px; display: flex; align-items: center; justify-content: center;"
              >
                <span class="password-toggle-icon" aria-hidden="true">üëÅ</span>
              </button>
            </div>
            <p id="api_key_help" class="form-help-text">
              Enter your API key to authenticate
            </p>
            <div id="api_key_error" class="form-error-message" role="alert" aria-live="assertive" style="{% if not error %}display: none;{% else %}display: block; color: var(--color-error, #F44336); font-size: var(--font-size-sm, 14px); margin-top: var(--spacing-xs, 4px);{% endif %}">
              {% if error %}{{ error }}{% endif %}
            </div>
          </div>
        </div>

        <div class="form-group" style="margin-bottom: var(--spacing-lg);">
          <button type="submit" class="btn btn-primary" style="width: 100%;" aria-label="Sign in to SentraScan Platform">
            <span class="button-text">Sign In</span>
            <span class="button-spinner" style="display: none;" aria-hidden="true">
              <span class="spinner spinner-sm"></span>
            </span>
            <span class="sr-only button-loading-text" style="display: none;">Signing in...</span>
          </button>
        </div>
      </fieldset>
    </form>

    <div class="login-footer" style="text-align: center; padding-top: var(--spacing-lg); border-top: 1px solid var(--color-border-light);">
      <p style="font-size: var(--font-size-sm); color: var(--color-text-secondary); margin: 0;">
        <span id="helpTextUser">Need help? Contact your administrator to create an account.</span>
        <span id="helpTextApiKey" style="display: none;">Need help? Contact your administrator for an API key.</span>
      </p>
    </div>
  </div>
</div>

<style>
/* Screen reader only class */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border-width: 0;
}
</style>

<script>
// Login form validation and functionality
(function() {
  const form = document.querySelector('.login-form');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const apiKeyInput = document.getElementById('api_key');
  const emailError = document.getElementById('email_error');
  const passwordError = document.getElementById('password_error');
  const apiKeyError = document.getElementById('api_key_error');
  const submitButton = form?.querySelector('button[type="submit"]');
  const buttonText = submitButton?.querySelector('.button-text');
  const buttonSpinner = submitButton?.querySelector('.button-spinner');
  const toggleButtons = document.querySelectorAll('.password-toggle');
  const userAuthFields = document.getElementById('userAuthFields');
  const apiKeyAuthFields = document.getElementById('apiKeyAuthFields');
  const authToggleButtons = document.querySelectorAll('.auth-toggle-btn');
  let currentAuthMethod = 'user'; // 'user' or 'api_key'

  // Authentication method toggle
  authToggleButtons.forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      const method = this.getAttribute('data-method');
      
      // Update active state
      authToggleButtons.forEach(b => {
        b.classList.remove('active');
        b.style.background = 'transparent';
        b.style.color = 'var(--color-text-secondary, #666)';
        b.setAttribute('aria-pressed', 'false');
      });
      this.classList.add('active');
      this.style.background = 'var(--color-primary, #0066cc)';
      this.style.color = 'white';
      this.setAttribute('aria-pressed', 'true');
      
      // Show/hide appropriate fields
      if (method === 'user') {
        userAuthFields.style.display = 'block';
        apiKeyAuthFields.style.display = 'none';
        emailInput.required = true;
        passwordInput.required = true;
        apiKeyInput.required = false;
        currentAuthMethod = 'user';
        document.getElementById('helpTextUser').style.display = 'inline';
        document.getElementById('helpTextApiKey').style.display = 'none';
        emailInput.focus();
      } else {
        userAuthFields.style.display = 'none';
        apiKeyAuthFields.style.display = 'block';
        emailInput.required = false;
        passwordInput.required = false;
        apiKeyInput.required = true;
        currentAuthMethod = 'api_key';
        document.getElementById('helpTextUser').style.display = 'none';
        document.getElementById('helpTextApiKey').style.display = 'inline';
        apiKeyInput.focus();
      }
    });
  });

  // Password toggle functionality for all password fields
  toggleButtons.forEach(toggleButton => {
    const passwordField = toggleButton.previousElementSibling;
    const toggleIcon = toggleButton.querySelector('.password-toggle-icon');
    
    if (passwordField && toggleButton) {
      toggleButton.addEventListener('click', function(e) {
        e.preventDefault();
        const isPassword = passwordField.type === 'password';
        
        passwordField.type = isPassword ? 'text' : 'password';
        toggleButton.setAttribute('aria-label', isPassword ? 'Hide password' : 'Show password');
        toggleButton.setAttribute('aria-pressed', isPassword ? 'true' : 'false');
        if (toggleIcon) {
          toggleIcon.textContent = isPassword ? 'üôà' : 'üëÅ';
        }
      });

      // Keyboard support for toggle
      toggleButton.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          toggleButton.click();
        }
      });
    }
  });

  // Validation functions
  function showError(message, field) {
    let errorElement, inputElement, helpId;
    
    if (field === 'email') {
      errorElement = emailError;
      inputElement = emailInput;
      helpId = 'email_help';
    } else if (field === 'password') {
      errorElement = passwordError;
      inputElement = passwordInput;
      helpId = 'password_help';
    } else if (field === 'api_key') {
      errorElement = apiKeyError;
      inputElement = apiKeyInput;
      helpId = 'api_key_help';
    } else {
      return;
    }
    
    if (!errorElement || !inputElement) return;
    
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    inputElement.classList.add('error');
    inputElement.setAttribute('aria-invalid', 'true');
    // Ensure error ID is in aria-describedby
    const currentDescribedBy = inputElement.getAttribute('aria-describedby') || '';
    const errorId = field + '_error';
    if (!currentDescribedBy.includes(errorId)) {
      inputElement.setAttribute('aria-describedby', (currentDescribedBy + ' ' + errorId).trim());
    }
    
    // Focus on input to announce error to screen readers
    inputElement.focus();
    
    // Scroll to error if needed (but don't interrupt focus)
    setTimeout(() => {
      errorElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }, 100);
  }

  function clearError(field) {
    let errorElement, inputElement, helpId;
    
    if (field === 'email') {
      errorElement = emailError;
      inputElement = emailInput;
      helpId = 'email_help';
    } else if (field === 'password') {
      errorElement = passwordError;
      inputElement = passwordInput;
      helpId = 'password_help';
    } else if (field === 'api_key') {
      errorElement = apiKeyError;
      inputElement = apiKeyInput;
      helpId = 'api_key_help';
    } else {
      return;
    }
    
    if (!errorElement || !inputElement) return;
    
    errorElement.textContent = '';
    errorElement.style.display = 'none';
    inputElement.classList.remove('error');
    inputElement.setAttribute('aria-invalid', 'false');
    inputElement.setAttribute('aria-describedby', helpId);
  }

  function validateEmail() {
    const value = emailInput.value.trim();
    
    if (!value) {
      showError('Email address is required', 'email');
      return false;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(value)) {
      showError('Please enter a valid email address', 'email');
      return false;
    }
    
    clearError('email');
    return true;
  }

  function validatePassword() {
    const value = passwordInput.value;
    
    if (!value) {
      showError('Password is required', 'password');
      return false;
    }
    
    if (value.length < 12) {
      showError('Password must be at least 12 characters long', 'password');
      return false;
    }
    
    clearError('password');
    return true;
  }

  function validateApiKey() {
    const value = apiKeyInput.value.trim();
    
    if (!value) {
      showError('API key is required', 'api_key');
      return false;
    }
    
    if (value.length < 1) {
      showError('API key cannot be empty', 'api_key');
      return false;
    }
    
    clearError('api_key');
    return true;
  }

  // Real-time validation on input
  if (emailInput) {
    emailInput.addEventListener('input', function() {
      {% if not error %}
      if (this.value.trim().length > 0) {
        clearError('email');
      }
      {% endif %}
    });

    emailInput.addEventListener('blur', function() {
      {% if not error %}
      if (this.value.trim().length === 0) {
        validateEmail();
      }
      {% endif %}
    });
  }

  if (passwordInput) {
    passwordInput.addEventListener('input', function() {
      {% if not error %}
      if (this.value.length > 0) {
        clearError('password');
      }
      {% endif %}
    });

    passwordInput.addEventListener('blur', function() {
      {% if not error %}
      if (this.value.length === 0) {
        validatePassword();
      }
      {% endif %}
    });
  }

  if (apiKeyInput) {
    apiKeyInput.addEventListener('input', function() {
      {% if not error %}
      if (this.value.trim().length > 0) {
        clearError('api_key');
      }
      {% endif %}
    });

    apiKeyInput.addEventListener('blur', function() {
      {% if not error %}
      if (this.value.trim().length === 0) {
        validateApiKey();
      }
      {% endif %}
    });
  }

  // Form submission validation
  if (form) {
    form.addEventListener('submit', function(e) {
      // Clear any previous client-side errors
      {% if not error %}
      if (currentAuthMethod === 'user') {
        clearError('email');
        clearError('password');
      } else {
        clearError('api_key');
      }
      {% endif %}
      
      // Validate before submission based on current auth method
      let isValid = false;
      if (currentAuthMethod === 'user') {
        isValid = validateEmail() && validatePassword();
        if (!isValid) {
          e.preventDefault();
          if (!emailInput.validity.valid) {
            emailInput.focus();
          } else if (!passwordInput.validity.valid) {
            passwordInput.focus();
          }
          return false;
        }
      } else {
        isValid = validateApiKey();
        if (!isValid) {
          e.preventDefault();
          apiKeyInput.focus();
          return false;
        }
      }

      // Show loading state
      if (submitButton && buttonText && buttonSpinner) {
        submitButton.disabled = true;
        buttonText.style.display = 'none';
        buttonSpinner.style.display = 'inline-flex';
        submitButton.setAttribute('aria-busy', 'true');
        
        // Announce loading state to screen readers
        const loadingText = submitButton.querySelector('.button-loading-text');
        if (loadingText) {
          loadingText.style.display = 'inline';
        }
        
        // Prevent multiple submissions
        form.setAttribute('data-submitting', 'true');
      }
    });
  }

  // Keyboard navigation enhancements
  if (apiKeyInput) {
    // Allow Enter key to submit form (default behavior, but ensure it works)
    apiKeyInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey && !e.metaKey) {
        // Let the form handle submission naturally
        // This ensures proper validation flow
      }
    });
  }

  // Focus management on page load
  // If there's a server error, focus on the input to announce it
  {% if error %}
  if (apiKeyInput) {
    // Small delay to ensure page is fully loaded
    setTimeout(function() {
      apiKeyInput.focus();
    }, 100);
  }
  {% endif %}

  // Handle HTML5 validation
  if (apiKeyInput) {
    apiKeyInput.addEventListener('invalid', function(e) {
      e.preventDefault();
      if (!this.validity.valid) {
        if (this.validity.valueMissing) {
          showError('API key is required');
        } else {
          showError('Please enter a valid API key');
        }
        this.focus();
      }
    });
  }
})();
</script>
{% endblock %}
